# DataConnector for PharmaMind AI

**一个为连锁药店行业量身打造的、商业级的通用数据同步工具。**

`DataConnector` 是 `PharmaMind AI` 智慧药店运营平台的核心数据管道。它被设计为一个部署在客户本地服务器上的独立Windows服务，能够安全、稳定、高效地从客户现有的ERP或业务数据库中，提取核心业务数据（如商品、销售、库存、会员等），并将其安全地上传到PharmaMind AI云端平台，为后续的BI分析和AI洞察提供动力。

<!-- 提示：请将此URL替换为您配置工具的真实截图链接 -->

## 核心特性

* **多数据库支持**: 内置了对 `Microsoft SQL Server` 和 `Oracle` 等主流企业级数据库的支持。
* **灵活的SQL查询**: 允许实施人员为每个同步任务，编写完全自定义的SQL提取脚本，能够轻松适配任何异构的数据库表结构。
* **增量同步与断点续传**: 内置了基于时间戳的增量同步机制。即使同步任务因网络等原因意外中断，重启后也能自动从中断点恢复，从根本上杜絕了数据的重复或遗漏。
* **商业级健壮性**:
    * **独立任务调度**: 为每个同步任务（如“商品信息”、“销售记录”）创建独立的定时器，确保任务之间互不干扰。
    * **任务锁机制**: 自动防止同一个任务的多个实例并发运行，避免了潜在的数据库死锁和数据错乱风险。
    * **幂等性接口设计**: 后端API具备幂等性，即使连接器重复发送同一批数据，也能保证数据只会被正确地创建一次。
* **企业级安全**:
    * **专属API密钥认证**: 采用与企业绑定的、长效的API密钥进行认证，远比传统的用户Token更安全、更适合机器对机器的通信。
    * **单实例运行**: 通过系统互斥锁，确保在任何时候，服务器上只有一个“数据连接器”实例在运行。
* **易于部署与管理**:
    * 提供了自动化的`.bat`脚本，能够一键完成服务的安装、卸载、启动和停止。
    * 将所有复杂的配置，都集成到了一个直观的图形化配置工具中。

## 系统架构

`DataConnector` 项目由两个核心部分组成：

1.  **配置工具 (`DataConnector.exe`)**: 一个Windows窗体应用程序，用于创建、配置和测试数据同步任务。它的用户是实施人员，而不是最终客户。
2.  **后台服务 (`DataConnector.Service.exe`)**: 一个没有界面的Windows服务。在配置完成后，它会被部署到客户的服务器上，在后台根据您设定的周期，7x24小时不间断地自动执行所有同步任务。

## 技术栈

* **客户端 (配置工具 & 后台服务)**: C# (.NET Framework 4.7.2)
* **后端API**: Python, Django, Django REST Framework

## 安装与部署

#### **前提条件**

* Windows Server 2012 R2 或更高版本
* .NET Framework 4.7.2 或更高版本

#### **部署步骤**

1.  **编译项目**:
    * 在Visual Studio中，将解决方案配置切换为 `Release` 模式。
    * 右键点击解决方案，选择“**生成解决方案**”。
2.  **打包文件**:
    * 在服务器上创建一个新的文件夹 (例如 `C:\DataConnectorService`)。
    * 将以下文件从您项目的 `DataConnector.Service\bin\Release` 目录中，复制到这个新文件夹中：
        * `DataConnector.Service.exe`
        * `DataConnector.Core.dll`
        * `Newtonsoft.Json.dll`
        * `Oracle.ManagedDataAccess.dll` (如果需要)
        * `install_service.bat`
3.  **放置配置文件**:
    * 使用 `DataConnector.exe` 配置工具，完成所有任务的配置后，将生成的 `config.json` 和 `sync_state.json` 文件，也复制到 `C:\DataConnectorService` 文件夹中。
4.  **安装并启动服务**:
    * **右键点击** `install_service.bat` 文件，选择“**以管理员身份运行**”。
    * 在弹出的菜单中，按 `1` 安装服务。
    * 安装成功后，按 `3` 启动服务。

## 配置指南

使用 `DataConnector.exe` 图形化配置工具，您可以完成所有同步任务的管理。

#### **1. 新增/删除任务**

* **新增任务**: 点击左下角的“新增任务”按钮，输入一个唯一的任务名称。
* **删除任务**: 在左侧列表中选中一个任务，然后点击“删除任务”按钮。

#### **2. 基础配置**

* **数据类型**: **(极其重要)** 选择此任务要同步的数据类型（如“商品信息”、“销售记录”）。程序会根据这个类型，去调用后端对应的API接口。
* **数据库类型**: 选择客户的数据库类型（目前支持 `Microsoft SQL Server` 和 `Oracle`）。
* **连接字符串**: 填写用于连接客户数据库的完整连接字符串。
* **API根地址**: 填写PharmaMind AI后端API的根地址 (例如 `http://your-api.com`)。
* **API密钥**: 填写您从PharmaMind AI后台为该企业生成的专属API密钥。

#### **3. 数据提取SQL**

这是“数据连接器”最核心的部分。您需要在这里编写SQL查询脚本，从客户的数据库中提取数据。

* **字段别名**: 查询出的字段名，**必须**使用 `AS` 关键字，将其重命名为我们后端API所期望的字段名。
* **增量同步占位符**: 对于需要增量同步的任务，请在 `WHERE` 条件中使用 `@LastSyncTime` 这个特殊的占位符。程序在运行时，会自动将其替换为上次成功同步的时间点。
* **强制排序**: 对于增量同步任务，**必须**在SQL脚本的末尾，使用 `ORDER BY [您的时间戳字段] ASC` 对结果进行升序排列，以确保“断点续传”功能的正确性。

**示例 (销售记录)**:
```sql
SELECT
    sale_id AS source_sale_id,
    store_code AS store_id,
    product_code AS product_id,
    sale_time AS sale_time,
    -- ... 其他字段
FROM
    Your_Sales_Table
WHERE
    sale_time > '@LastSyncTime'
ORDER BY
    sale_time ASC
```

#### **4. 高级配置**

* **上传策略**:
    * `合并更新`: 用于主数据（如商品、门店）。程序会根据主键，智能地判断是新增还是更新记录。
    * `仅追加`: 用于交易数据（如销售、采购）。程序只会将新数据追加到数据库中。
    * `全量快照`: 用于库存这类数据。每次同步都会删除旧数据，并用最新的数据完全替换。
* **增量同步字段名称**: **(极其重要)** 这个字段的名称，**必须**与您在SQL脚本中为时间戳字段指定的**别名**完全一致。在上面的示例中，这里就应该填写 `sale_time`。
* **同步周期(分钟)**: 设置这个任务在后台服务中被自动执行的频率。
* **下次运行时强制全量同步**: 勾选此项后，该任务在下一次运行时，会忽略上次的同步时间点，从头开始同步所有数据。成功执行一次后，此选项会自动取消勾选。

## 日志与故障排查

* **服务日志**: 后台服务的所有运行日志，都会被记录在与 `DataConnector.Service.exe` 同目录下的 `service_log.txt` 文件中。
* **Windows事件日志**: 服务也会将关键的启动、停止和错误信息，写入到Windows的“事件查看器”中，日志源为 `DataConnectorServiceSource`。

## 许可证

本项目采用 [MIT许可证](https://opensource.org/licenses/MIT)。
